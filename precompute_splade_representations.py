# run precompute
# CUDA_VISIBLE_DEVICES=0 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v6" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=1 DATASET_TO_USE="trec_covid" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v6" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=2 DATASET_TO_USE="scidocs" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v6" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=2 DATASET_TO_USE="scifact" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v6" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=2 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v11-2" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py

# CUDA_VISIBLE_DEVICES=2 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v6-1" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=1 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v6-2" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=0 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v6-3" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=2 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v6-4" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=1 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v6-5" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py


# CUDA_VISIBLE_DEVICES=2 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v7-1" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=1 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v7-2" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=0 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v7-3" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=2 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v7-4" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=1 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v7-5" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py

# CUDA_VISIBLE_DEVICES=1 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_no_titles_v6-1" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=1 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_no_queries_v6-1" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=1 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_no_cc_v6-1" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py

# CUDA_VISIBLE_DEVICES=2 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v8-1" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=1 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v8-2" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=0 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v8-3" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py


# CUDA_VISIBLE_DEVICES=2 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v9-1" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=1 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v9-2" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=0 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_v9-3" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py


# CUDA_VISIBLE_DEVICES=0 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_no_titles_v8-1" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=1 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_no_queries_v8-1" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py
# CUDA_VISIBLE_DEVICES=2 DATASET_TO_USE="scirepeval_search_validation_evaluation" INFORMATIVENESS_MODEL_NAME="custom_trained_combined_references_no_cc_v8-1" OUTPUT_FOLDER="/scratch/lamdo/precompute_sparse_representations" python precompute_splade_representations.py


import os, json
from tqdm import tqdm
from src.process_dataset import process_dataset
# from src.two_stage_keyphrase_extraction_with_splade import get_tokens_scores_of_doc, init_splade_model
from src.splade_inference import get_tokens_scores_of_docs_batch, init_splade_model, SPLADE_MODEL


DATASET_TO_USE = os.environ["DATASET_TO_USE"]
INFORMATIVENESS_MODEL_NAME = os.environ["INFORMATIVENESS_MODEL_NAME"]

OUTPUT_FOLDER = os.environ["OUTPUT_FOLDER"]

OUTFILE = os.path.join(OUTPUT_FOLDER, f"{INFORMATIVENESS_MODEL_NAME}--{DATASET_TO_USE}.jsonl")

init_splade_model(INFORMATIVENESS_MODEL_NAME)

dataset = process_dataset(dataset_name=DATASET_TO_USE)

batch_size = 16

with open(OUTFILE, "w") as outfile:
    for i in tqdm(range(0, len(dataset), batch_size)):
        batch = dataset[i:i+batch_size]
        batch = [sample.get('text').lower() for sample in batch]

        docs_tokens = SPLADE_MODEL[INFORMATIVENESS_MODEL_NAME]["tokenizer"](batch, return_tensors="pt", max_length = 512, padding = True, truncation = True)
        # document = sample.get("text")

        batch_tokens_scores = get_tokens_scores_of_docs_batch(
            docs_tokens=docs_tokens,
            model_name=INFORMATIVENESS_MODEL_NAME
        )

        # tokens_scores = get_tokens_scores_of_doc(
        #     doc = document,
        #     model_name=INFORMATIVENESS_MODEL_NAME
        # )

        for tokens_scores in batch_tokens_scores:
            json.dump(dict(tokens_scores), outfile)
            outfile.write('\n')